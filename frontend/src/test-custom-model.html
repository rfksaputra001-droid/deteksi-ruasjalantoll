<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Custom YOLO Model - YOLO Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
</head>
<body class="bg-gray-50 min-h-screen p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">üéØ Test Custom YOLO Model</h1>
        
        <!-- Login Section -->
        <div id="loginSection" class="mb-8 p-6 bg-blue-50 border border-blue-200 rounded-lg">
            <h3 class="text-xl font-semibold text-blue-800 mb-4">Login Required</h3>
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-blue-700 mb-2">Email:</label>
                    <input type="email" id="loginEmail" value="surveyor@test.com" class="w-full p-2 border border-blue-300 rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium text-blue-700 mb-2">Password:</label>
                    <input type="password" id="loginPassword" value="123456" class="w-full p-2 border border-blue-300 rounded-lg">
                </div>
            </div>
            <button id="loginBtn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700">
                üîë LOGIN
            </button>
        </div>

        <!-- Model Info Section -->
        <div id="modelSection" class="mb-8 p-6 bg-green-50 border border-green-200 rounded-lg hidden">
            <h3 class="text-xl font-semibold text-green-800 mb-4">üìä Current Model Info</h3>
            <div id="modelInfo" class="space-y-2 text-sm">
                <!-- Model info will be populated here -->
            </div>
            <button id="refreshModelBtn" class="mt-4 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700">
                üîÑ Refresh Model Info
            </button>
        </div>

        <!-- Model Upload Section -->
        <div id="uploadSection" class="mb-8 p-6 bg-yellow-50 border border-yellow-200 rounded-lg hidden">
            <h3 class="text-xl font-semibold text-yellow-800 mb-4">üöÄ Upload Custom YOLO Model</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-yellow-700 mb-2">Select .pt Model File:</label>
                <input type="file" id="modelFile" accept=".pt" class="w-full p-3 border border-yellow-300 rounded-lg">
            </div>
            <button id="uploadModelBtn" class="w-full bg-yellow-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-yellow-700">
                ‚¨ÜÔ∏è UPLOAD CUSTOM MODEL
            </button>
        </div>

        <!-- Video Testing Section -->
        <div id="testSection" class="mb-8 p-6 bg-purple-50 border border-purple-200 rounded-lg hidden">
            <h3 class="text-xl font-semibold text-purple-800 mb-4">üé¨ Test Video Detection</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-purple-700 mb-2">Select Video File:</label>
                <input type="file" id="videoFile" accept="video/*" class="w-full p-3 border border-purple-300 rounded-lg">
            </div>
            <button id="testVideoBtn" class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-purple-700">
                üéØ TEST DETECTION WITH CURRENT MODEL
            </button>
        </div>

        <!-- Progress Section -->
        <div id="progressSection" class="mb-8 p-6 bg-gray-50 border border-gray-200 rounded-lg hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">üìà Detection Progress</h3>
            <div id="progressContent">
                <div class="bg-gray-200 rounded-full h-4 mb-2">
                    <div id="progressBar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm text-gray-600">Ready...</p>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="mb-8 p-6 bg-green-50 border border-green-200 rounded-lg hidden">
            <h3 class="text-lg font-semibold text-green-800 mb-4">üéä Detection Results</h3>
            <div id="resultsContent">
                <!-- Results will be populated here -->
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-gray-100 p-6 rounded-lg">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">üìã Instructions</h3>
            <ol class="list-decimal list-inside space-y-2 text-sm text-gray-700">
                <li>Login dengan account surveyor atau admin</li>
                <li>Cek info model yang sedang digunakan</li>
                <li>Upload model custom Anda (.pt file) jika ada</li>
                <li>Test deteksi video dengan model yang aktif</li>
                <li>Lihat hasil deteksi real-time dengan Socket.IO</li>
            </ol>
            
            <div class="mt-4 p-4 bg-blue-100 rounded-lg">
                <h4 class="font-semibold text-blue-800 mb-2">üîç Custom Model Features:</h4>
                <ul class="list-disc list-inside space-y-1 text-sm text-blue-700">
                    <li>Auto-detect model classes dari .pt file</li>
                    <li>Dynamic color mapping untuk setiap class</li>
                    <li>Normalisasi vehicle types (car‚Üímobil, motorcycle‚Üímotor, etc.)</li>
                    <li>Support model yang dilatih dengan classes custom</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://deteksi-ruasjalantoll.onrender.com';
        let socket = null;
        let currentToken = null;
        let currentTrackingId = null;
        
        // Elements
        const loginSection = document.getElementById('loginSection');
        const modelSection = document.getElementById('modelSection');
        const uploadSection = document.getElementById('uploadSection');
        const testSection = document.getElementById('testSection');
        const progressSection = document.getElementById('progressSection');
        const resultsSection = document.getElementById('resultsSection');
        
        const loginBtn = document.getElementById('loginBtn');
        const uploadModelBtn = document.getElementById('uploadModelBtn');
        const testVideoBtn = document.getElementById('testVideoBtn');
        const refreshModelBtn = document.getElementById('refreshModelBtn');
        
        // Login
        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ emailUser: email, passwordUser: password })
                });
                
                const data = await response.json();
                if (data.status === 'success' && data.data.token) {
                    currentToken = data.data.token;
                    loginSection.classList.add('hidden');
                    modelSection.classList.remove('hidden');
                    uploadSection.classList.remove('hidden');
                    testSection.classList.remove('hidden');
                    
                    initSocket();
                    getModelInfo();
                    
                    console.log('‚úÖ Login successful:', data.data.user);
                    return true;
                }
                throw new Error(data.message || 'Login gagal');
            } catch (error) {
                alert(`‚ùå Login error: ${error.message}`);
                return false;
            }
        }
        
        // Get model info
        async function getModelInfo() {
            try {
                const response = await fetch(`${API_BASE}/api/deteksi/model-info`, {
                    headers: { 'Authorization': `Bearer ${currentToken}` }
                });
                
                const data = await response.json();
                if (data.success) {
                    const info = data.data;
                    document.getElementById('modelInfo').innerHTML = `
                        <p><strong>Current Model:</strong> ${info.current_model}</p>
                        <p><strong>Is Custom:</strong> ${info.is_custom ? '‚úÖ Yes' : '‚ùå No'}</p>
                        <p><strong>Model Loaded:</strong> ${info.model_loaded ? '‚úÖ Yes' : '‚ùå No'}</p>
                        <p><strong>Total Classes:</strong> ${info.total_classes || 'Unknown'}</p>
                        ${info.classes ? `<p><strong>Classes:</strong> ${Object.values(info.classes).join(', ')}</p>` : ''}
                    `;
                }
            } catch (error) {
                console.error('Model info error:', error);
            }
        }
        
        // Upload model
        async function uploadModel() {
            const file = document.getElementById('modelFile').files[0];
            if (!file) {
                alert('Pilih file model terlebih dahulu!');
                return;
            }
            
            uploadModelBtn.disabled = true;
            uploadModelBtn.textContent = '‚è≥ Uploading...';
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE}/api/deteksi/upload-model`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${currentToken}` },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`‚úÖ Model uploaded successfully!\nClasses: ${Object.values(result.data.classes).join(', ')}`);
                    getModelInfo();
                } else {
                    alert(`‚ùå Upload failed: ${result.message}`);
                }
                
            } catch (error) {
                alert(`‚ùå Upload error: ${error.message}`);
            } finally {
                uploadModelBtn.disabled = false;
                uploadModelBtn.textContent = '‚¨ÜÔ∏è UPLOAD CUSTOM MODEL';
            }
        }
        
        // Test video detection
        async function testVideo() {
            const file = document.getElementById('videoFile').files[0];
            if (!file) {
                alert('Pilih file video terlebih dahulu!');
                return;
            }
            
            testVideoBtn.disabled = true;
            testVideoBtn.textContent = '‚è≥ Processing...';
            progressSection.classList.remove('hidden');
            resultsSection.classList.add('hidden');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                const response = await fetch(`${API_BASE}/api/deteksi/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${currentToken}` },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success && result.data.tracking_id) {
                    currentTrackingId = result.data.tracking_id;
                    document.getElementById('progressText').textContent = 'üöÄ Upload berhasil! Memulai deteksi...';
                    
                    // Join socket room
                    if (socket && socket.connected) {
                        socket.emit('join_detection', { tracking_id: currentTrackingId });
                    }
                } else {
                    throw new Error(result.message || 'Upload gagal');
                }
                
            } catch (error) {
                alert(`‚ùå Test error: ${error.message}`);
                testVideoBtn.disabled = false;
                testVideoBtn.textContent = 'üéØ TEST DETECTION WITH CURRENT MODEL';
            }
        }
        
        // Initialize Socket.IO
        function initSocket() {
            socket = io(API_BASE, {
                transports: ['polling', 'websocket'],
                withCredentials: true
            });
            
            socket.on('connect', () => {
                console.log('üîå Socket connected:', socket.id);
            });
            
            socket.on('detection-progress', (data) => {
                console.log('üìä Progress:', data);
                updateProgress(data);
            });
            
            socket.on('detection-status-changed', (data) => {
                console.log('üéâ Status changed:', data);
                if (data.stage === 'completed') {
                    showResults(data);
                } else if (data.stage === 'error') {
                    alert(`‚ùå Error: ${data.message}`);
                    resetUI();
                }
            });
            
            socket.on('connect_error', (err) => {
                console.error('‚ùå Socket error:', err);
            });
        }
        
        // Update progress
        function updateProgress(data) {
            const progress = data.progress || 0;
            document.getElementById('progressBar').style.width = `${progress}%`;
            document.getElementById('progressText').textContent = data.message || 'Processing...';
        }
        
        // Show results
        function showResults(data) {
            resultsSection.classList.remove('hidden');
            const results = data.results || {};
            const detection = results.detection_results || {};
            
            document.getElementById('resultsContent').innerHTML = `
                <h4 class="font-semibold text-green-800 mb-2">üéØ Detection Complete!</h4>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <p><strong>Tracking ID:</strong> ${data.trackingId}</p>
                        <p><strong>Filename:</strong> ${results.filename}</p>
                        <p><strong>Total Detections:</strong> ${detection.total_detections || 0}</p>
                    </div>
                    <div>
                        <p><strong>Vehicle Counts:</strong></p>
                        <ul class="ml-4">
                            ${Object.entries(detection.vehicle_counts || {}).map(([type, count]) => 
                                `<li>‚Ä¢ ${type}: ${count}</li>`
                            ).join('')}
                        </ul>
                    </div>
                </div>
                ${results.processed_video_url ? 
                    `<p class="mt-4"><strong>Processed Video:</strong> 
                     <a href="${results.processed_video_url}" target="_blank" class="text-blue-600 underline">View Video</a></p>` : 
                    '<p class="mt-4 text-gray-500">Video tidak di-upload ke Cloudinary</p>'}
            `;
            
            resetUI();
        }
        
        // Reset UI
        function resetUI() {
            testVideoBtn.disabled = false;
            testVideoBtn.textContent = 'üéØ TEST DETECTION WITH CURRENT MODEL';
            currentTrackingId = null;
        }
        
        // Event listeners
        loginBtn.addEventListener('click', login);
        uploadModelBtn.addEventListener('click', uploadModel);
        testVideoBtn.addEventListener('click', testVideo);
        refreshModelBtn.addEventListener('click', getModelInfo);
    </script>
</body>
</html>