<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Video Upload - YOLO Detection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
</head>
<body class="bg-gray-50 min-h-screen p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">ğŸš€ Test Video Upload</h1>
        
        <!-- Status Display -->
        <div id="status" class="mb-6 p-4 rounded-lg bg-blue-50 border border-blue-200">
            <h3 class="font-semibold text-blue-800 mb-2">Status:</h3>
            <p id="statusText" class="text-blue-700">Siap untuk upload video...</p>
            <div class="mt-3">
                <div class="bg-blue-200 rounded-full h-2">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm text-blue-600 mt-1">0%</p>
            </div>
        </div>

        <!-- Upload Form -->
        <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Pilih Video (MP4, AVI, MOV):</label>
            <input type="file" id="videoFile" accept="video/*" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <button id="uploadBtn" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:bg-gray-400">
            ğŸ¬ UPLOAD & DETEKSI
        </button>

        <!-- Results -->
        <div id="results" class="mt-8 hidden">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">ğŸ“Š Hasil Deteksi:</h3>
            <div id="resultContent" class="bg-green-50 border border-green-200 rounded-lg p-4">
                <!-- Results will be populated here -->
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://deteksi-ruasjalantoll.onrender.com';
        const SOCKET_URL = API_BASE;
        
        // Test credentials
        const testUser = {
            emailUser: 'rifkitest123@gmail.com',
            passwordUser: '123456'
        };
        
        let socket = null;
        let currentToken = null;
        let currentTrackingId = null;
        
        // Elements
        const uploadBtn = document.getElementById('uploadBtn');
        const videoFile = document.getElementById('videoFile');
        const statusText = document.getElementById('statusText');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const results = document.getElementById('results');
        const resultContent = document.getElementById('resultContent');
        
        // Login and get token
        async function login() {
            try {
                const response = await fetch(`${API_BASE}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testUser)
                });
                
                const data = await response.json();
                if (data.status === 'success' && data.data.token) {
                    currentToken = data.data.token;
                    statusText.textContent = 'âœ… Login berhasil! Siap upload video.';
                    return true;
                }
                throw new Error(data.message || 'Login gagal');
            } catch (error) {
                statusText.textContent = `âŒ Login error: ${error.message}`;
                return false;
            }
        }
        
        // Initialize Socket.IO
        function initSocket() {
            socket = io(SOCKET_URL, {
                transports: ['websocket', 'polling']
            });
            
            socket.on('connect', () => {
                console.log('ğŸ”Œ Socket connected:', socket.id);
            });
            
            socket.on('detection-progress', (data) => {
                console.log('ğŸ“Š Progress:', data);
                updateProgress(data);
            });
            
            socket.on('detection-status-changed', (data) => {
                console.log('ğŸ‰ Status changed:', data);
                if (data.stage === 'completed') {
                    showResults(data);
                } else if (data.stage === 'error') {
                    statusText.textContent = `âŒ Error: ${data.message}`;
                    uploadBtn.disabled = false;
                }
            });
        }
        
        // Update progress
        function updateProgress(data) {
            const progress = data.progress || 0;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${progress}%`;
            statusText.textContent = data.message || 'Processing...';
        }
        
        // Show results
        function showResults(data) {
            results.classList.remove('hidden');
            const results_data = data.results || {};
            const detection = results_data.detection_results || {};
            
            resultContent.innerHTML = `
                <h4 class="font-semibold text-green-800 mb-2">ğŸ¯ Deteksi Selesai!</h4>
                <p><strong>Tracking ID:</strong> ${data.trackingId}</p>
                <p><strong>Total Deteksi:</strong> ${detection.total_detections || 0}</p>
                <p><strong>Mobil:</strong> ${detection.vehicle_counts?.mobil || 0}</p>
                <p><strong>Motor:</strong> ${detection.vehicle_counts?.motor || 0}</p>
                <p><strong>Truk:</strong> ${detection.vehicle_counts?.truk || 0}</p>
                <p><strong>Bus:</strong> ${detection.vehicle_counts?.bus || 0}</p>
                ${results_data.processed_video_url ? `<p><strong>Video URL:</strong> <a href="${results_data.processed_video_url}" target="_blank" class="text-blue-600 underline">Lihat Video</a></p>` : ''}
            `;
            
            uploadBtn.disabled = false;
            uploadBtn.textContent = 'ğŸ¬ UPLOAD VIDEO LAIN';
        }
        
        // Upload video
        async function uploadVideo() {
            const file = videoFile.files[0];
            if (!file) {
                alert('Pilih file video terlebih dahulu!');
                return;
            }
            
            if (!currentToken) {
                alert('Token tidak valid! Refresh halaman.');
                return;
            }
            
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'â³ UPLOADING...';
            results.classList.add('hidden');
            
            try {
                const formData = new FormData();
                formData.append('file', file);
                
                statusText.textContent = 'ğŸ“¤ Mengirim video ke server...';
                
                const response = await fetch(`${API_BASE}/api/deteksi/upload`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success && result.data.tracking_id) {
                    currentTrackingId = result.data.tracking_id;
                    statusText.textContent = 'ğŸš€ Upload berhasil! Memulai deteksi...';
                    
                    // Join socket room for real-time updates
                    if (socket && socket.connected) {
                        socket.emit('join-detection-room', { trackingId: currentTrackingId });
                    }
                } else {
                    throw new Error(result.message || 'Upload gagal');
                }
                
            } catch (error) {
                statusText.textContent = `âŒ Upload error: ${error.message}`;
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ğŸ¬ UPLOAD & DETEKSI';
            }
        }
        
        // Initialize
        async function init() {
            statusText.textContent = 'ğŸ”„ Menginisialisasi...';
            
            if (await login()) {
                initSocket();
            }
        }
        
        // Event listeners
        uploadBtn.addEventListener('click', uploadVideo);
        
        // Start
        init();
    </script>
</body>
</html>